<div class="grades-container">
  
  <!-- HEADER -->
  <div class="header">
    <button mat-icon-button (click)="cancel()" class="back-button">
      <mat-icon>arrow_back</mat-icon>
    </button>
    <h1>Captura de Calificaciones</h1>
  </div>

  <!-- MENSAJES -->
  <div *ngIf="successMessage" class="success-message">
    <mat-icon>check_circle</mat-icon>
    <p>{{ successMessage }}</p>
  </div>

  <div *ngIf="errorMessage && !isLoadingAssignments" class="error-message">
    <mat-icon>error</mat-icon>
    <p>{{ errorMessage }}</p>
  </div>

  <!-- CARD PRINCIPAL -->
  <mat-card class="grades-card">
    <mat-card-content>
      
      <!-- FILTROS -->
      <form [formGroup]="gradesForm" class="filters-section">
        <h3 class="section-title">Filtros de B칰squeda</h3>
        
        <div class="filters-row">
          
          <!-- Filtro Sistema -->
          <mat-form-field appearance="outline">
            <mat-label>Sistema</mat-label>
            <mat-select formControlName="sistema" (selectionChange)="applyFilters()">
              <mat-option *ngFor="let sistema of sistemas" [value]="sistema">
                {{ sistema }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <!-- Filtro Grupo -->
          <mat-form-field appearance="outline">
            <mat-label>Grupo</mat-label>
            <mat-select formControlName="grupo" (selectionChange)="applyFilters()">
              <mat-option *ngFor="let grupo of grupos" [value]="grupo">
                {{ grupo }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <!-- Filtro Materia -->
          <mat-form-field appearance="outline">
            <mat-label>Materia</mat-label>
            <mat-select formControlName="materia" (selectionChange)="applyFilters()">
              <mat-option *ngFor="let materia of materias" [value]="materia">
                {{ materia }}
              </mat-option>
            </mat-select>
          </mat-form-field>

        </div>

        <!-- SELECTOR DE ASIGNACI칍N -->
        <div class="assignment-selector">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Materia y Grupo</mat-label>
            <mat-select 
              formControlName="asignacionId" 
              (selectionChange)="onAsignacionChange($event)"
              [disabled]="isLoadingAssignments">
              <mat-option 
                *ngFor="let asignacion of asignaciones" 
                [value]="asignacion.id">
                {{ asignacion.materia }} - Grupo {{ asignacion.grupo }} ({{ asignacion.sistema }})
              </mat-option>
            </mat-select>
          </mat-form-field>

          <!-- SPINNER DE CARGA -->
          <div class="loading-section" *ngIf="isLoadingAssignments">
            <mat-spinner diameter="40"></mat-spinner>
            <p>Cargando asignaciones...</p>
          </div>
        </div>

        <!-- Info de selecci칩n actual -->
        <div class="selection-info" *ngIf="selectedAsignacion">
          <mat-icon>info</mat-icon>
          <span>
            Materia: <strong>{{ selectedAsignacion.materia }}</strong> - 
            Grupo <strong>{{ selectedAsignacion.grupo }}</strong> -
            Sistema <strong>{{ selectedAsignacion.sistema }}</strong>
          </span>
        </div>
      </form>

      <!-- TABLA DE CALIFICACIONES -->
      <div class="table-container" *ngIf="selectedAsignacion && !isLoadingStudents">
        <table mat-table [dataSource]="alumnosFormArray.controls" class="grades-table">

          <!-- Columna N칰mero -->
          <ng-container matColumnDef="numero">
            <th mat-header-cell *matHeaderCellDef>#</th>
            <td mat-cell *matCellDef="let alumno; let i = index">
              {{ i + 1 }}
            </td>
          </ng-container>

          <!-- Columna Matr칤cula -->
          <ng-container matColumnDef="matricula">
            <th mat-header-cell *matHeaderCellDef>Matr칤cula</th>
            <td mat-cell *matCellDef="let alumno">
              {{ alumno.get('matricula')?.value }}
            </td>
          </ng-container>

          <!-- Columna Nombre Completo -->
          <ng-container matColumnDef="nombreCompleto">
            <th mat-header-cell *matHeaderCellDef>Nombre Completo</th>
            <td mat-cell *matCellDef="let alumno">
              {{ alumno.get('nombreCompleto')?.value }}
            </td>
          </ng-container>

          <!-- Columna Parcial 1 -->
          <ng-container matColumnDef="p1">
            <th mat-header-cell *matHeaderCellDef>Parcial 1 (30%)</th>
            <td mat-cell *matCellDef="let alumno; let i = index">
              <mat-form-field appearance="outline" class="grade-input">
                <input 
                  matInput 
                  type="number" 
                  [formControl]="alumno.get('p1')"
                  min="0" 
                  max="100"
                  (blur)="validateGrade($event, i, 'p1')"
                  placeholder="0-100">
                <mat-error *ngIf="alumno.get('p1')?.hasError('min') || alumno.get('p1')?.hasError('max')">
                  0-100
                </mat-error>
              </mat-form-field>
            </td>
          </ng-container>

          <!-- Columna Parcial 2 -->
          <ng-container matColumnDef="p2">
            <th mat-header-cell *matHeaderCellDef>Parcial 2 (30%)</th>
            <td mat-cell *matCellDef="let alumno; let i = index">
              <mat-form-field appearance="outline" class="grade-input">
                <input 
                  matInput 
                  type="number" 
                  [formControl]="alumno.get('p2')"
                  min="0" 
                  max="100"
                  (blur)="validateGrade($event, i, 'p2')"
                  placeholder="0-100">
                <mat-error *ngIf="alumno.get('p2')?.hasError('min') || alumno.get('p2')?.hasError('max')">
                  0-100
                </mat-error>
              </mat-form-field>
            </td>
          </ng-container>

          <!-- Columna Parcial 3 -->
          <ng-container matColumnDef="p3">
            <th mat-header-cell *matHeaderCellDef>Parcial 3 (40%)</th>
            <td mat-cell *matCellDef="let alumno; let i = index">
              <mat-form-field appearance="outline" class="grade-input">
                <input 
                  matInput 
                  type="number" 
                  [formControl]="alumno.get('p3')"
                  min="0" 
                  max="100"
                  (blur)="validateGrade($event, i, 'p3')"
                  placeholder="0-100">
                <mat-error *ngIf="alumno.get('p3')?.hasError('min') || alumno.get('p3')?.hasError('max')">
                  0-100
                </mat-error>
              </mat-form-field>
            </td>
          </ng-container>

          <!-- Columna Promedio -->
          <ng-container matColumnDef="total">
            <th mat-header-cell *matHeaderCellDef>Promedio</th>
            <td mat-cell *matCellDef="let alumno">
              <span class="promedio-badge" 
                    [ngClass]="getPromedioClass(alumno.get('total')?.value)">
                {{ alumno.get('total')?.value || 0 | number:'1.1-1' }}
              </span>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

        </table>

        <!-- Mensaje si no hay alumnos -->
        <div *ngIf="alumnosFormArray.length === 0" class="no-data">
          <mat-icon>school</mat-icon>
          <p>No hay alumnos para mostrar</p>
          <p class="hint">Selecciona una materia y grupo en los filtros</p>
        </div>
      </div>

      <!-- SPINNER DE CARGA ESTUDIANTES -->
      <div class="loading-section" *ngIf="isLoadingStudents">
        <mat-spinner diameter="40"></mat-spinner>
        <p>Cargando lista de alumnos...</p>
      </div>

      <!-- RESUMEN -->
      <div class="resumen-section" *ngIf="selectedAsignacion && alumnosFormArray.length > 0">
        <div class="resumen-card">
          <mat-icon>people</mat-icon>
          <div class="resumen-content">
            <span class="resumen-label">Total Alumnos</span>
            <span class="resumen-value">{{ alumnosFormArray.length }}</span>
          </div>
        </div>

        <div class="resumen-card aprobados">
          <mat-icon>check_circle</mat-icon>
          <div class="resumen-content">
            <span class="resumen-label">Aprobados</span>
            <span class="resumen-value">{{ getResumenCalificaciones().aprobados }}</span>
          </div>
        </div>

        <div class="resumen-card reprobados">
          <mat-icon>cancel</mat-icon>
          <div class="resumen-content">
            <span class="resumen-label">Reprobados</span>
            <span class="resumen-value">{{ getResumenCalificaciones().reprobados }}</span>
          </div>
        </div>

        <div class="resumen-card promedio">
          <mat-icon>trending_up</mat-icon>
          <div class="resumen-content">
            <span class="resumen-label">Promedio Grupo</span>
            <span class="resumen-value">{{ getResumenCalificaciones().promedioGrupo | number:'1.1-1' }}</span>
          </div>
        </div>
      </div>

      <!-- BOTONES DE ACCI칍N -->
      <div class="actions-section" *ngIf="selectedAsignacion && alumnosFormArray.length > 0">
        <div class="changes-indicator" *ngIf="hasChanges">
          <mat-icon>edit</mat-icon>
          <span>Tienes cambios sin guardar</span>
        </div>

        <div class="button-group">
          <button 
            mat-raised-button 
            (click)="cancel()"
            [disabled]="isLoading">
            Cancelar
          </button>

          <button 
            mat-raised-button 
            color="primary"
            (click)="saveGrades()"
            [disabled]="isLoading || !hasChanges || gradesForm.invalid">
            <mat-spinner *ngIf="isLoading" diameter="20" class="button-spinner"></mat-spinner>
            <span *ngIf="!isLoading">Guardar Calificaciones</span>
          </button>
        </div>
      </div>

    </mat-card-content>
  </mat-card>

  <!-- INSTRUCCIONES -->
  <div class="instructions-card">
    <h3>游닇 Instrucciones:</h3>
    <ul>
      <li>Selecciona el <strong>Sistema</strong>, <strong>Grupo</strong> y <strong>Materia</strong> en los filtros</li>
      <li>Elige la asignaci칩n espec칤fica en el selector <strong>"Materia y Grupo"</strong></li>
      <li>Ingresa las calificaciones para cada parcial:
        <ul>
          <li><strong>Parcial 1:</strong> 30% de la calificaci칩n final</li>
          <li><strong>Parcial 2:</strong> 30% de la calificaci칩n final</li>
          <li><strong>Parcial 3:</strong> 40% de la calificaci칩n final</li>
        </ul>
      </li>
      <li>Las calificaciones deben estar entre <strong>0 y 100</strong></li>
      <li>El <strong>Promedio</strong> se calcula autom치ticamente</li>
      <li>Haz clic en <strong>Guardar Calificaciones</strong> para registrar los cambios</li>
    </ul>
  </div>

</div>